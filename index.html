<!-- å…ƒãƒã‚¿: https://www.twilio.com/blog/speech-recognition-browser-web-speech-api-jp -->
<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Browser speech recognition</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <header>
      <h1>Browser speech recognition</h1>
    </header>
    <main>
      <div id="result"></div>
      <p id="message" hidden aria-hidden="true">
        ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯"Speech Recognition"ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        ãã®ãŸã‚ã€ã“ã®æ©Ÿèƒ½ã¯ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
        Chromeã§ã¯ãŠãã‚‰ãä½¿ãˆã¾ã™ã®ã§ã€ãã¡ã‚‰ã§ãŠè©¦ã—ãã ã•ã„ã€‚
      </p>
      <p id="recog-status">(éŸ³å£°èªè­˜ä¸­)</p>
      <button id="button">Start listening</button>
      <button id="post_button">ç¾åœ¨ã€Discordã«æŠ•ç¨¿ã•ã‚Œã¾ã™</button>
      <div id="other">
        <span>
          <div class="setting-area">
            <select class="classic" id="langKbn">
              <option value="ja-jp">æ—¥æœ¬èª(Japanese)</option>
              <option value="en-us">è‹±èª(English)</option>
            </select>
            <span class="switchArea" id="switch" title="éŸ³å£°èªè­˜ç¶™ç¶šON/OFF">
              éŸ³å£°ç¶™ç¶š<input type="checkbox" id="switch2" checked />
              <label for="switch2"><span></span></label>
              <div id="swImg"></div>
            </span>
            <span class="switchArea" id="switch" title="ç·¨é›†å¯èƒ½ON/OFF">
              çµæœç·¨é›†<input type="checkbox" id="switch1" />
              <label for="switch1"><span></span></label>
              <div id="swImg"></div>
            </span>
          </div>
        </span>
        <div class="stuff">
          <span class="textBox">
            <input
              id="name"
              class="text"
              type="textbox"
              placeholder="åå‰"
              onkeyup="this.setAttribute('value', this.value);"
              value=""
            />
            <label class="label">åå‰</label>
            <label class="error"></label>
          </span>
          <span class="textBox">
            <input
              id="webhook_url"
              class="text"
              type="password"
              placeholder="Webhook URLã‚’å…¥åŠ›ã—æœ‰åŠ¹ã«ã™ã‚‹ã¨Discordã«æŠ•ç¨¿ã•ã‚Œã¾ã™"
              onkeyup="this.setAttribute('value', this.value);"
              value=""
            />
            <label class="label">Webhook URL</label>
            <label class="error"></label>
          </span>
          <span class="textBox">
            <input
              id="bot_name"
              class="text"
              type="textbox"
              placeholder="Discordã«æŠ•ç¨¿ã™ã‚‹éš›ã®åå‰"
              onkeyup="this.setAttribute('value', this.value);"
              value="éŸ³å£°èªè­˜ãã‚“"
            />
            <label class="label">bot_name</label>
            <label class="error"></label>
          </span>
          <span class="textBox">
            <input
              id="bot_avatar_url"
              class="text"
              type="textbox"
              placeholder="Discordã«æŠ•ç¨¿ã™ã‚‹éš›ã®ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®URL"
              onkeyup="this.setAttribute('value', this.value);"
              value="https://i.imgur.com/Wyw2lgj.png"
            />
            <label class="label">bot_avatar_url</label>
            <label class="error"></label>
          </span>
        </div>
        <!-- <span>åå‰: <input type="text" id="name" /></span>
        <span>URL: <input type="password" id="webhook_url" size="29" maxlength="120"></span> -->
      </div>
    </main>
    <footer>
      <p>Built with ğŸ™ by <a href="https://twitter.com/philnash">philnash</a></p>
      <p>
        ä¸Šè¨˜ã®ã‚„ã¤ã‚’ã¡ã‚‡ã£ã¨æ”¹é€ ã—ãŸ(<a
          href="https://github.com/philnash/web-assistant/"
          >å…ƒãƒã‚¿</a
        >) by tetsuya-ki
      </p>
      <p>
        &copy;2019 Phil Nsahã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯<a
          href="https://github.com/philnash/web-assistant/blob/master/LICENSE"
          >MIT LICENSE</a
        >
      </p>
      <p>&copy;2022 tetsuya-kiã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯MIT LICENSE</p>
    </footer>
    <script>
      let POST_FLAG = false; // æŠ•ç¨¿ã—ãŸããªã„å ´åˆ(ãƒ‡ãƒãƒƒã‚°ç­‰)ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤
      window.addEventListener("DOMContentLoaded", () => {
        const button = document.getElementById("button");
        const discord_post_button = document.getElementById("post_button");
        const result = document.getElementById("result");
        const main = document.getElementsByTagName("main")[0];
        const status = document.getElementById("recog-status");
        const langKbn = document.getElementById("langKbn");
        const name = document.getElementById("name");
        const switch1 = document.getElementById("switch1");
        const switch2 = document.getElementById("switch2");
        const webhook_url = document.getElementById("webhook_url");
        const bot_name = document.getElementById("bot_name");
        const bot_avatar_url = document.getElementById("bot_avatar_url");
        status.style.visibility = "hidden";
        let listening = false;
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (typeof SpeechRecognition !== "undefined") {
          const recognition = new SpeechRecognition();
          // éŸ³å£°ã¨ã—ã¦èªè­˜ã•ã‚ŒãŸéŸ³ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€éŸ³å£°èªè­˜ä¸­ã§ã‚ã‚‹æ—¨è¡¨ç¤º
          recognition.onspeechstart = () => {
            status.style.visibility = "visible";
          };

          // éŸ³å£°ãŒæ­¢ã¾ã£ãŸå ´åˆã€èªè­˜ä¸­è¡¨ç¤ºã‚’æ¶ˆã™
          recognition.onsoundend = () => {
            status.style.visibility = "hidden"; // éŸ³å£°èªè­˜ä¸­ã§ã‚ã‚‹æ—¨ã‚’æ¶ˆã™
          };

          const stop = () => {
            main.classList.remove("speaking");
            recognition.stop();
            recognition.onend = () => {}; // éŸ³å£°èªè­˜ãŒæ­¢ã¾ã£ãŸå ´åˆã®å‡¦ç†ç¶™ç¶šã‚‚æ­¢ã‚ã‚‹
            button.textContent = "Start listening";
          };

          const start = () => {
            main.classList.add("speaking");
            recognition.start();
            button.textContent = "Stop listening";
            recognition.onend = () => {
              // éŸ³å£°èªè­˜ãŒæ­¢ã¾ã£ãŸå ´åˆã®å‡¦ç†ç¶™ç¶šã‚’é–‹å§‹
              button.textContent = "Start listening";
              main.classList.remove("speaking");
              recognition.start();
              main.classList.add("speaking");
              button.textContent = "Stop listening";
            };
          };

          const post_start = () => {
            discord_post_button.textContent = "DiscordæŠ•ç¨¿ä¸­";
            POST_FLAG = true;
            discord_post_button.style.backgroundColor = "#f22f46";
            discord_post_button.style.color = "#fff";
          };
          const post_stop = () => {
            discord_post_button.textContent = "DiscordæŠ•ç¨¿ã—ãªã„";
            POST_FLAG = false;
            discord_post_button.style.backgroundColor = null;
            discord_post_button.style.color = "#f22f46";
          };
          !POST_FLAG ? post_stop() : post_start();
          const onResult = (event) => {
            // https://developer.mozilla.org/ja/docs/Web/API/SpeechRecognition ã‚’å‚è€ƒã«ã—ãŸ
            // datelog(event);
            for (i = 0; i < event.results.length; i++) {
              let final_num = 0;
              let text_list = [];
              if (event.results[i].isFinal) {
                text_list.push(event.results[i][0].transcript);
                final_num++;
              }
              // å…¨ã¦éŸ³å£°èªè­˜ãŒç¢ºå®šã•ã‚ŒãŸå ´åˆã€ä¸€æ—¦å‡¦ç†ã‚’æ­¢ã‚ã‚‹
              if (final_num === event.results.length) {
                // ã‚„ã‚„ã“ã—ããªã‚‹ãŸã‚ä¸€æ—¦å‡¦ç†ã‚’æ­¢ã‚ã‚‹ãŒã€ã¾ãŸå‡¦ç†ãŒèµ·å‹•ã™ã‚‹æƒ³å®š(recognition.onendã‚¤ãƒ™ãƒ³ãƒˆã§å‹•ã‹ã™ãŸã‚)
                status.style.visibility = "hidden"; // éŸ³å£°èªè­˜ä¸­ã§ã‚ã‚‹æ—¨ã‚’æ¶ˆã™
                recognition.stop();

                // åå‰ã®èª¿æ•´
                let user_name = "éŸ³å£°èªè­˜ãã‚“";
                if (bot_name.value !== "") {
                  user_name = bot_name.value;
                }
                let pname = "";
                if (name.value !== "") {
                  pname = "(" + name.value + ")";
                  user_name += pname;
                }

                for (const text of text_list) {
                  // ã—ã‚‡ã¼ã„æ–‡å­—æ•°ã ã£ãŸã‚‰ä½•ã‚‚ã—ãªã„
                  if (!text || text.length <= 3) {
                    continue;
                  }
                  let name_and_text = text;
                  name_and_text = pname + " " + text;
                  const now = new Date();
                  const now_datetime = now.toLocaleString();
                  const now_and_text = now_datetime + ": " + name_and_text;

                  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°å‡ºåŠ›ã—ã€ç”»é¢ã«è¡¨ç¤º
                  datelog(name_and_text);
                  result.innerHTML += "<div>" + now_and_text + "</div>";

                  // Webhookã‚’ä½¿ã£ã¦Discordã¸ãƒã‚¹ãƒˆ
                  let requestPayload = {
                    content: text, // éŸ³å£°èªè­˜ã•ã‚ŒãŸæ–‡å­—åˆ—
                    username: user_name, // è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶å
                    parse: "full", // URLå±•é–‹ã™ã‚‹ã‹ã©ã†ã‹ã¿ãŸã„ãªãƒ¤ãƒ„ã ã£ãŸæ°—ãŒã™ã‚‹
                  };
                  // ã‚¢ãƒã‚¿ãƒ¼ã®ç”»åƒãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ä½¿ã†
                  if (bot_avatar_url.value !== "") {
                    requestPayload.avatar_url = bot_avatar_url.value;
                  }
                  // POST_FLAGãŒOFFã‹ã¤WebhookURLãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                  if (POST_FLAG && webhook_url.value === "") {
                    datelog("webhook_urlãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                  } else if (text && text.length >= 5 && POST_FLAG) {
                    postData(webhook_url.value, requestPayload).then((data) => {
                      //datelog(data); // data.json() ã®å‘¼ã³å‡ºã—ã§è§£é‡ˆã•ã‚ŒãŸ JSON ãƒ‡ãƒ¼ã‚¿(ãƒ‡ãƒãƒƒã‚°ç”¨)
                    });
                  }
                }
              }
            }
          };
          recognition.continuous = true; //éŸ³å£°èªè­˜ã‚’ç¶™ç¶šã™ã‚‹ã‹â†’Yes
          //recognition.interimResults = true;//ä¸­é–“çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‹â†’Yes
          recognition.addEventListener("result", onResult);
          button.addEventListener("click", (event) => {
            listening ? stop() : start();
            listening = !listening;
          });
          // DiscordæŠ•ç¨¿çŠ¶æ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
          discord_post_button.addEventListener("click", (event) => {
            POST_FLAG ? post_stop() : post_start();
          });
          // è¨€èªè¨­å®šãƒªã‚¹ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
          langKbn.addEventListener("change", (event) => {
            recognition.lang = langKbn.value;
          });
          // çµæœç·¨é›†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
          switch1.addEventListener("change", (event) => {
            switch1.checked
              ? (result.contentEditable = true)
              : (result.contentEditable = false);
            datelog("result.contentEditable:" + result.contentEditable);
          });
          // éŸ³å£°ç¶™ç¶šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
          switch2.addEventListener("change", (event) => {
            switch2.checked
              ? (recognition.continuous = true)
              : (recognition.continuous = false);
            datelog("recognition.continuous:" + recognition.continuous);
          });
        } else {
          // SpeechRecognitionãŒä½¿ãˆãªã„å ´åˆã¯ã€ãƒœã‚¿ãƒ³ãªã©ä½¿ãˆãªã„ã‚ˆã†ã«ã—ã€ãƒ€ãƒ¡ã§ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
          button.remove();
          const message = document.getElementById("message");
          message.removeAttribute("hidden");
          message.setAttribute("aria-hidden", "false");
        }
      });
      async function postData(url = "", data = {}) {
        // æ—¢å®šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯ * ãŒä»˜ã„ã¦ã„ã¾ã™
        const response = await fetch(url, {
          method: "POST", // *GET, POST, PUT, DELETE, etc.
          mode: "cors", // no-cors, *cors, same-origin
          cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
          credentials: "same-origin", // include, *same-origin, omit
          headers: {
            "Content-Type": "application/json",
          },
          redirect: "follow", // manual, *follow, error
          referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
          body: JSON.stringify(data), // æœ¬æ–‡ã®ãƒ‡ãƒ¼ã‚¿å‹ã¯ "Content-Type" ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        });
        return response; // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
      }
      function datelog(text = "") {
        const now = new Date();
        const now_datetime = now.toLocaleString();
        console.log(now_datetime + ": " + text);
      }
    </script>
  </body>
</html>
